import{V as h,C as x,B as $,a as G,S as W,A as J,P as H,T as K,G as L,b as U,M,c as y,d as C,e as B,f as N,g as T,h as V,D as R,i as Y,j,E as _,W as Z,k as Q,l as tt,m as et,n as it,o as st,p as ot,q as nt,r as D,s as at,F as rt,t as ct,u as lt,v as k,w as X}from"./three-DDYte0Kc.js";function vt(){import.meta.url,import("_").catch(()=>1),(async function*(){})().next()}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class ht{constructor(){this.colliders=[],this.staticColliders=[]}addCollider(t,e=!1){(e?this.staticColliders:this.colliders).push(t)}removeCollider(t){let e=this.colliders.indexOf(t);if(e!==-1){this.colliders.splice(e,1);return}e=this.staticColliders.indexOf(t),e!==-1&&this.staticColliders.splice(e,1)}checkCollision(t,e){return t.collisionType==="sphere"&&e.collisionType==="sphere"?this.checkSphereCollision(t,e):t.collisionType==="box"&&e.collisionType==="box"?this.checkAABBCollision(t,e):t.collisionType==="sphere"&&e.collisionType==="box"||t.collisionType==="box"&&e.collisionType==="sphere"?this.checkSphereAABBCollision(t,e):!1}checkSphereCollision(t,e){const i=t.position.distanceTo(e.position),s=t.radius+e.radius;return i<=s}checkAABBCollision(t,e){const i=t.position.clone().sub(t.size.clone().multiplyScalar(.5)),s=t.position.clone().add(t.size.clone().multiplyScalar(.5)),o=e.position.clone().sub(e.size.clone().multiplyScalar(.5)),n=e.position.clone().add(e.size.clone().multiplyScalar(.5));return i.x<=n.x&&s.x>=o.x&&i.y<=n.y&&s.y>=o.y&&i.z<=n.z&&s.z>=o.z}checkSphereAABBCollision(t,e){const i=t.collisionType==="sphere"?t:e,s=t.collisionType==="box"?t:e,o=s.position.clone().sub(s.size.clone().multiplyScalar(.5)),n=s.position.clone().add(s.size.clone().multiplyScalar(.5)),r=new h(Math.max(o.x,Math.min(i.position.x,n.x)),Math.max(o.y,Math.min(i.position.y,n.y)),Math.max(o.z,Math.min(i.position.z,n.z)));return i.position.distanceTo(r)<=i.radius}checkCollisions(t){const e=[];for(const i of this.colliders)i!==t&&this.checkCollision(t,i)&&e.push(i);for(const i of this.staticColliders)this.checkCollision(t,i)&&e.push(i);return e}}class dt{constructor(){this.buoyancyForce=2,this.dragCoefficient=.95,this.currentDirection=new h(.1,0,.05),this.currentStrength=.02}applyBuoyancy(t,e){const i=new h(0,this.buoyancyForce*e,0);t.velocity.add(i)}applyDrag(t){t.velocity.multiplyScalar(this.dragCoefficient)}applyCurrent(t,e=1,i){const s=this.currentDirection.clone().multiplyScalar(this.currentStrength*e*i);t.velocity.add(s)}applyUnderwaterEffects(t,e){this.applyBuoyancy(t,e),this.applyDrag(t),this.applyCurrent(t,1,e)}}class ut{constructor(){this.gravity=new h(0,-9.8,0),this.waterDensity=1e3,this.collisionSystem=new ht,this.underwaterPhysics=new dt,this.rigidBodies=[],this.isUnderwater=!0}addRigidBody(t){this.rigidBodies.push(t),t.collisionType&&this.collisionSystem.addCollider(t,t.isStatic)}removeRigidBody(t){const e=this.rigidBodies.indexOf(t);e!==-1&&(this.rigidBodies.splice(e,1),this.collisionSystem.removeCollider(t))}update(t){for(const e of this.rigidBodies)this.updateBody(e,t)}updateBody(t,e){if(t.isStatic)return;t.velocity||(t.velocity=new h);const i=t.position.clone();if(this.isUnderwater)this.underwaterPhysics.applyUnderwaterEffects(t,e);else{const n=this.gravity.clone().multiplyScalar(e);t.velocity.add(n)}const s=t.velocity.clone().multiplyScalar(e);t.position.add(s);const o=this.collisionSystem.checkCollisions(t);o.length>0&&this.resolveCollisions(t,o,i)}resolveCollisions(t,e,i){e.filter(o=>(o.type!=="collectible"||o.collected)&&o.type!=="gate").length>0&&(t.position.copy(i),t.velocity.multiplyScalar(.3)),t.onCollision&&t.onCollision(e)}checkCollisions(){const t=[];for(let e=0;e<this.rigidBodies.length;e++){const i=this.rigidBodies[e],s=this.collisionSystem.checkCollisions(i);for(const o of s)t.push([i,o])}return t}createSphereBody(t,e,i=!1){return{position:t.clone(),velocity:new h,collisionType:"sphere",radius:e,isStatic:i}}createBoxBody(t,e,i=!1){return{position:t.clone(),velocity:new h,collisionType:"box",size:e.clone(),isStatic:i}}}class mt{constructor(t,e,i,s,o){this.position=t.clone(),this.velocity=e.clone(),this.life=i,this.maxLife=i,this.size=s,this.color=o.clone(),this.alpha=1,this.active=!0}update(t){this.active&&(this.position.add(this.velocity.clone().multiplyScalar(t)),this.life-=t,this.alpha=this.life/this.maxLife,this.life<=0&&(this.active=!1))}reset(t,e,i,s,o){this.position.copy(t),this.velocity.copy(e),this.life=i,this.maxLife=i,this.size=s,this.color.copy(o),this.alpha=1,this.active=!0}}class pt{constructor(t,e=1e3){this.scene=t,this.maxParticles=e,this.particles=[],this.emitters=[],this.initializeParticlePool(),this.createParticleRenderSystem(),this.createUnderwaterEmitters()}initializeParticlePool(){for(let t=0;t<this.maxParticles;t++){const e=new mt(new h,new h,1,1,new x(16777215));e.active=!1,this.particles.push(e)}}createParticleRenderSystem(){this.geometry=new $,this.positions=new Float32Array(this.maxParticles*3),this.colors=new Float32Array(this.maxParticles*3),this.sizes=new Float32Array(this.maxParticles),this.alphas=new Float32Array(this.maxParticles),this.geometry.setAttribute("position",new G(this.positions,3)),this.geometry.setAttribute("color",new G(this.colors,3)),this.geometry.setAttribute("size",new G(this.sizes,1)),this.geometry.setAttribute("alpha",new G(this.alphas,1)),this.material=new W({uniforms:{time:{value:0},pointTexture:{value:this.createParticleTexture()}},vertexShader:"\n        attribute float size;\n        attribute float alpha;\n        attribute vec3 color;\n        \n        varying float vAlpha;\n        varying vec3 vColor;\n        \n        void main() {\n          vAlpha = alpha;\n          vColor = color;\n          \n          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n          gl_PointSize = size * (300.0 / -mvPosition.z);\n          gl_Position = projectionMatrix * mvPosition;\n        }\n      ",fragmentShader:"\n        uniform sampler2D pointTexture;\n        \n        varying float vAlpha;\n        varying vec3 vColor;\n        \n        void main() {\n          vec4 texColor = texture2D(pointTexture, gl_PointCoord);\n          gl_FragColor = vec4(vColor, vAlpha * texColor.a);\n        }\n      ",transparent:!0,blending:J,depthWrite:!1}),this.points=new H(this.geometry,this.material),this.scene.add(this.points)}createParticleTexture(){const t=document.createElement("canvas");t.width=64,t.height=64;const e=t.getContext("2d"),i=e.createRadialGradient(32,32,0,32,32,32);i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.2,"rgba(255,255,255,0.8)"),i.addColorStop(.4,"rgba(255,255,255,0.4)"),i.addColorStop(1,"rgba(255,255,255,0)"),e.fillStyle=i,e.fillRect(0,0,64,64);const s=new K(t);return s.needsUpdate=!0,s}createUnderwaterEmitters(){this.addEmitter({type:"bubbles",position:new h(0,-10,0),rate:5,life:8,size:{min:2,max:6},velocity:new h(0,2,0),velocityVariation:new h(.5,.5,.5),color:new x(8900331),colorVariation:.1,area:new h(20,2,20)}),this.addEmitter({type:"debris",position:new h(0,0,0),rate:3,life:15,size:{min:1,max:3},velocity:new h(.1,.05,.1),velocityVariation:new h(.3,.2,.3),color:new x(16777215),colorVariation:.2,area:new h(40,20,40)}),this.addEmitter({type:"lightRays",position:new h(0,15,0),rate:.5,life:20,size:{min:8,max:15},velocity:new h(0,-.5,0),velocityVariation:new h(.1,.2,.1),color:new x(16766720),colorVariation:.1,area:new h(30,5,30)})}addEmitter(t){const e={...t,accumulator:0,active:!0};this.emitters.push(e)}emitParticle(t){const e=this.particles.find(r=>!r.active);if(!e)return;const i=t.position.clone().add(new h((Math.random()-.5)*t.area.x,(Math.random()-.5)*t.area.y,(Math.random()-.5)*t.area.z)),s=t.velocity.clone().add(new h((Math.random()-.5)*t.velocityVariation.x,(Math.random()-.5)*t.velocityVariation.y,(Math.random()-.5)*t.velocityVariation.z)),o=t.size.min+Math.random()*(t.size.max-t.size.min),n=t.color.clone();t.colorVariation>0&&n.offsetHSL((Math.random()-.5)*t.colorVariation,0,(Math.random()-.5)*t.colorVariation*.5),e.reset(i,s,t.life,o,n)}createBurst(t,e={}){const i=e.count||20,s=e.life||2,o=e.velocity||new h(0,1,0),n=e.velocityVariation||new h(2,2,2),r=e.color||new x(16766720),a=e.size||{min:2,max:8};for(let c=0;c<i;c++){const l=this.particles.find(m=>!m.active);if(!l)break;const d=o.clone().add(new h((Math.random()-.5)*n.x,(Math.random()-.5)*n.y,(Math.random()-.5)*n.z)),p=a.min+Math.random()*(a.max-a.min);l.reset(t.clone(),d,s,p,r)}}update(t){for(const i of this.emitters){if(!i.active)continue;i.accumulator+=t;const s=1/i.rate;for(;i.accumulator>=s;)this.emitParticle(i),i.accumulator-=s}let e=0;for(let i=0;i<this.particles.length;i++){const s=this.particles[i];if(s.active){s.update(t);const o=e*3;this.positions[o]=s.position.x,this.positions[o+1]=s.position.y,this.positions[o+2]=s.position.z,this.colors[o]=s.color.r,this.colors[o+1]=s.color.g,this.colors[o+2]=s.color.b,this.sizes[e]=s.size,this.alphas[e]=s.alpha,e++}}this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.attributes.size.needsUpdate=!0,this.geometry.attributes.alpha.needsUpdate=!0,this.geometry.setDrawRange(0,e),this.material.uniforms.time.value+=t}setEmitterActive(t,e){const i=this.emitters.find(s=>s.type===t);i&&(i.active=e)}clear(){for(const t of this.particles)t.active=!1}dispose(){this.scene.remove(this.points),this.geometry.dispose(),this.material.dispose(),this.material.uniforms.pointTexture.value&&this.material.uniforms.pointTexture.value.dispose()}}class yt{constructor(){this.audioContext=null,this.listener=null,this.sounds=new Map,this.isInitialized=!1,this.isMuted=!1,this.masterVolume=.5,this.musicVolume=.5,this.sfxVolume=.5,this.underwaterFilterFrequency=800,this.reverbAmount=.3,this.loadSettings(),console.log("🔊 AudioEngine created")}async initialize(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.listener=this.audioContext.listener,this.masterGain=this.audioContext.createGain(),this.masterGain.gain.setValueAtTime(this.masterVolume,this.audioContext.currentTime),this.masterGain.connect(this.audioContext.destination),this.musicGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.musicGain.gain.setValueAtTime(this.musicVolume,this.audioContext.currentTime),this.sfxGain.gain.setValueAtTime(this.sfxVolume,this.audioContext.currentTime),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.createUnderwaterEffects(),this.createSoundEffects(),this.isInitialized=!0,console.log("✅ AudioEngine initialized successfully")}catch(t){console.warn("⚠️ AudioEngine initialization failed:",t)}}createUnderwaterEffects(){this.audioContext&&(this.underwaterFilter=this.audioContext.createBiquadFilter(),this.underwaterFilter.type="lowpass",this.underwaterFilter.frequency.setValueAtTime(this.underwaterFilterFrequency,this.audioContext.currentTime),this.underwaterFilter.Q.setValueAtTime(1,this.audioContext.currentTime),this.underwaterFilter.connect(this.masterGain),console.log("🌊 Underwater audio effects created"))}createSoundEffects(){this.audioContext&&(this.soundConfigs={starCollect:{type:"sine",frequency:880,duration:.4,volume:.3,envelope:{attack:.01,decay:.1,sustain:.8,release:.3},harmonics:[{frequency:1320,volume:.5},{frequency:1760,volume:.3}]},gateActivate:{type:"triangle",frequency:220,duration:1.5,volume:.4,envelope:{attack:.2,decay:.3,sustain:.7,release:.5},modulation:{frequency:4,depth:20}},levelComplete:{type:"square",frequency:440,duration:2.5,volume:.5,envelope:{attack:.1,decay:.2,sustain:.8,release:.4},melody:[440,554.37,659.25,880]},swimming:{type:"sine",frequency:200,duration:.2,volume:.15,envelope:{attack:.05,decay:.1,sustain:.5,release:.05}},underwater:{type:"sine",frequency:80,duration:-1,volume:.12,envelope:{attack:2,decay:0,sustain:1,release:2},modulation:{frequency:.3,depth:5}}},console.log("🎵 Enhanced sound effects configured"))}playSound(t,e=null){if(!this.isInitialized||this.isMuted||!this.audioContext)return;const i=this.soundConfigs[t];if(!i){console.warn('Sound "'.concat(t,'" not found'));return}try{const s=this.audioContext.currentTime;if(i.melody){this.playMelody(i,e);return}const o=this.audioContext.createOscillator(),n=this.audioContext.createGain();if(o.type=i.type,o.frequency.setValueAtTime(i.frequency,s),i.modulation){const m=this.audioContext.createOscillator(),u=this.audioContext.createGain();m.frequency.setValueAtTime(i.modulation.frequency,s),u.gain.setValueAtTime(i.modulation.depth,s),m.connect(u),u.connect(o.frequency),m.start(s),i.duration>0&&m.stop(s+i.duration)}const r=i.envelope||{attack:.01,decay:.1,sustain:.8,release:.2},a=s+r.attack,c=a+r.decay,l=i.volume*r.sustain,d=i.duration>0?s+i.duration:s+1;n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(i.volume,a),n.gain.linearRampToValueAtTime(l,c),n.gain.setValueAtTime(l,d-r.release),n.gain.linearRampToValueAtTime(0,d),o.connect(n);const p=[];if(i.harmonics&&i.harmonics.forEach(m=>{const u=this.audioContext.createOscillator(),w=this.audioContext.createGain();u.type=i.type,u.frequency.setValueAtTime(m.frequency,s),w.gain.setValueAtTime(m.volume*i.volume,s),w.gain.linearRampToValueAtTime(0,d),u.connect(w),w.connect(n),u.start(s),i.duration>0&&u.stop(d),p.push(u)}),e){const m=this.audioContext.createPanner();m.panningModel="HRTF",m.setPosition(e.x,e.y,e.z),n.connect(m),m.connect(this.underwaterFilter),this.underwaterFilter.connect(this.sfxGain)}else n.connect(this.underwaterFilter),this.underwaterFilter.connect(this.sfxGain);o.start(s),i.duration>0&&o.stop(d),console.log("🔊 Playing enhanced sound: ".concat(t))}catch(s){console.warn('Failed to play sound "'.concat(t,'":'),s)}}playMelody(t,e=null){const i=t.duration/t.melody.length;t.melody.forEach((s,o)=>{const n=this.audioContext.currentTime+o*i,r=this.audioContext.createOscillator(),a=this.audioContext.createGain();if(r.type=t.type,r.frequency.setValueAtTime(s,n),a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(t.volume,n+.05),a.gain.linearRampToValueAtTime(0,n+i-.05),r.connect(a),e){const c=this.audioContext.createPanner();c.panningModel="HRTF",c.setPosition(e.x,e.y,e.z),a.connect(c),c.connect(this.underwaterFilter),this.underwaterFilter.connect(this.sfxGain)}else a.connect(this.underwaterFilter),this.underwaterFilter.connect(this.sfxGain);r.start(n),r.stop(n+i)})}startAmbientSound(){if(!(!this.isInitialized||this.isMuted)&&!this.ambientOscillator)try{this.ambientOscillator=this.audioContext.createOscillator(),this.ambientGain=this.audioContext.createGain(),this.ambientOscillator.type="sine",this.ambientOscillator.frequency.setValueAtTime(60,this.audioContext.currentTime),this.ambientGain.gain.setValueAtTime(0,this.audioContext.currentTime),this.ambientGain.gain.linearRampToValueAtTime(.08,this.audioContext.currentTime+3),this.ambientOscillator.connect(this.ambientGain),this.ambientGain.connect(this.underwaterFilter),this.underwaterFilter.connect(this.musicGain),this.ambientOscillator.start(),this.createBackgroundMusic(),console.log("🌊 Ambient underwater sound and music started")}catch(t){console.warn("Failed to start ambient sound:",t)}}createBackgroundMusic(){this.musicLayers=[],[{frequency:110,volume:.03,type:"sine"},{frequency:146.83,volume:.025,type:"sine"},{frequency:164.81,volume:.02,type:"triangle"},{frequency:220,volume:.015,type:"sine"}].forEach((e,i)=>{const s=this.audioContext.createOscillator(),o=this.audioContext.createGain(),n=this.audioContext.createOscillator(),r=this.audioContext.createGain();s.type=e.type,s.frequency.setValueAtTime(e.frequency,this.audioContext.currentTime),n.type="sine",n.frequency.setValueAtTime(.1+i*.05,this.audioContext.currentTime),r.gain.setValueAtTime(2,this.audioContext.currentTime),n.connect(r),r.connect(s.frequency),o.gain.setValueAtTime(0,this.audioContext.currentTime),o.gain.linearRampToValueAtTime(e.volume,this.audioContext.currentTime+5+i),s.connect(o),o.connect(this.underwaterFilter),this.underwaterFilter.connect(this.musicGain),s.start(),n.start(),this.musicLayers.push({oscillator:s,gainNode:o,lfo:n,lfoGain:r})})}stopAmbientSound(){if(this.ambientOscillator)try{this.ambientGain.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+1),this.ambientOscillator.stop(this.audioContext.currentTime+1),this.ambientOscillator=null,this.ambientGain=null}catch(t){console.warn("Error stopping ambient sound:",t)}this.musicLayers&&(this.musicLayers.forEach(t=>{try{t.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+1),t.oscillator.stop(this.audioContext.currentTime+1),t.lfo.stop(this.audioContext.currentTime+1)}catch(e){console.warn("Error stopping music layer:",e)}}),this.musicLayers=null),console.log("🔇 Ambient sound and music stopped")}updateListenerPosition(t,e,i){if(!(!this.listener||!this.isInitialized))try{this.listener.positionX?(this.listener.positionX.setValueAtTime(t.x,this.audioContext.currentTime),this.listener.positionY.setValueAtTime(t.y,this.audioContext.currentTime),this.listener.positionZ.setValueAtTime(t.z,this.audioContext.currentTime),this.listener.forwardX.setValueAtTime(e.x,this.audioContext.currentTime),this.listener.forwardY.setValueAtTime(e.y,this.audioContext.currentTime),this.listener.forwardZ.setValueAtTime(e.z,this.audioContext.currentTime),this.listener.upX.setValueAtTime(i.x,this.audioContext.currentTime),this.listener.upY.setValueAtTime(i.y,this.audioContext.currentTime),this.listener.upZ.setValueAtTime(i.z,this.audioContext.currentTime)):(this.listener.setPosition(t.x,t.y,t.z),this.listener.setOrientation(e.x,e.y,e.z,i.x,i.y,i.z))}catch(s){}}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.masterGain&&this.audioContext&&this.masterGain.gain.setValueAtTime(this.masterVolume,this.audioContext.currentTime),this.saveSettings()}setMusicVolume(t){this.musicVolume=Math.max(0,Math.min(1,t)),this.musicGain&&this.audioContext&&this.musicGain.gain.setValueAtTime(this.musicVolume,this.audioContext.currentTime),this.saveSettings()}setSfxVolume(t){this.sfxVolume=Math.max(0,Math.min(1,t)),this.sfxGain&&this.audioContext&&this.sfxGain.gain.setValueAtTime(this.sfxVolume,this.audioContext.currentTime),this.saveSettings()}toggleMute(){return this.isMuted=!this.isMuted,this.isMuted?this.stopAmbientSound():this.isInitialized&&this.startAmbientSound(),console.log("🔊 Audio ".concat(this.isMuted?"muted":"unmuted")),this.isMuted}getState(){return{isInitialized:this.isInitialized,isMuted:this.isMuted,masterVolume:this.masterVolume,musicVolume:this.musicVolume,sfxVolume:this.sfxVolume}}loadSettings(){var t,e,i;try{const s=localStorage.getItem("oceanAdventure_audioSettings");if(s){const o=JSON.parse(s);this.masterVolume=(t=o.masterVolume)!=null?t:.5,this.musicVolume=(e=o.musicVolume)!=null?e:.5,this.sfxVolume=(i=o.sfxVolume)!=null?i:.5}}catch(s){console.warn("Failed to load audio settings:",s)}}saveSettings(){try{const t={masterVolume:this.masterVolume,musicVolume:this.musicVolume,sfxVolume:this.sfxVolume};localStorage.setItem("oceanAdventure_audioSettings",JSON.stringify(t))}catch(t){console.warn("Failed to save audio settings:",t)}}dispose(){this.stopAmbientSound(),this.audioContext&&this.audioContext.state!=="closed"&&this.audioContext.close(),this.sounds.clear(),this.isInitialized=!1,console.log("🗑️ AudioEngine disposed")}}class ft{constructor(t,e){this.scene=t,this.physicsEngine=e,this.moveSpeed=8,this.rotationSpeed=3,this.maxVelocity=5,this.movementVector=new h,this.isMoving=!1,this.createPlayerMesh(),this.createPhysicsBody(),this.physicsBody.onCollision=i=>this.handleCollisions(i)}createPlayerMesh(){this.mesh=new L;const t=new U(.3,1.2,4,8),e=new M({color:16628916,transparent:!0,opacity:.95,shininess:30,specular:4473924}),i=new y(t,e);i.castShadow=!0,i.receiveShadow=!0,this.mesh.add(i);const s=new C(.25,8,6),o=new M({color:16628916,shininess:20}),n=new y(s,o);n.position.set(0,.9,0),n.castShadow=!0,n.receiveShadow=!0,this.mesh.add(n);const r=new U(.08,.6,4,6),a=new M({color:16628916,shininess:20}),c=new y(r,a);c.position.set(-.4,.3,0),c.rotation.z=.3,c.castShadow=!0,c.receiveShadow=!0,this.mesh.add(c);const l=new y(r,a);l.position.set(.4,.3,0),l.rotation.z=-.3,l.castShadow=!0,l.receiveShadow=!0,this.mesh.add(l);const d=new U(.1,.8,4,6),p=new M({color:16628916,shininess:20}),m=new y(d,p);m.position.set(-.15,-.9,0),m.castShadow=!0,m.receiveShadow=!0,this.mesh.add(m);const u=new y(d,p);u.position.set(.15,-.9,0),u.castShadow=!0,u.receiveShadow=!0,this.mesh.add(u);const w=new C(.28,8,6),f=new M({color:3355443,transparent:!0,opacity:.8,shininess:100}),g=new y(w,f);g.position.set(0,.9,.1),g.scale.set(1,.6,.8),this.mesh.add(g),this.bodyParts={leftArm:c,rightArm:l,leftLeg:m,rightLeg:u},this.mesh.position.set(0,-8,0),this.scene.add(this.mesh)}createPhysicsBody(){this.physicsBody=this.physicsEngine.createSphereBody(this.mesh.position.clone(),1,!1),this.physicsEngine.addRigidBody(this.physicsBody)}handleInput(t){this.movementVector.set(0,0,0),this.isMoving=!1,t.keys&&(t.keys.forward&&(this.movementVector.z-=1,this.isMoving=!0),t.keys.backward&&(this.movementVector.z+=1,this.isMoving=!0),t.keys.left&&(this.movementVector.x-=1,this.isMoving=!0),t.keys.right&&(this.movementVector.x+=1,this.isMoving=!0),t.keys.up&&(this.movementVector.y+=1,this.isMoving=!0),t.keys.down&&(this.movementVector.y-=1,this.isMoving=!0)),t.joystick&&(this.movementVector.x+=t.joystick.x,this.movementVector.z+=t.joystick.y,(Math.abs(t.joystick.x)>.1||Math.abs(t.joystick.y)>.1)&&(this.isMoving=!0)),t.mobileButtons&&(t.mobileButtons.swimUp&&(this.movementVector.y+=1,this.isMoving=!0),t.mobileButtons.swimDown&&(this.movementVector.y-=1,this.isMoving=!0)),this.movementVector.length()>1&&this.movementVector.normalize(),this.applyMovement()}applyMovement(){if(!this.isMoving){this.physicsBody.velocity.multiplyScalar(.9);return}const t=this.movementVector.clone().multiplyScalar(this.moveSpeed*.05);if(this.physicsBody.velocity.add(t),this.physicsBody.velocity.length()>this.maxVelocity&&this.physicsBody.velocity.normalize().multiplyScalar(this.maxVelocity),this.movementVector.length()>.1){const e=Math.atan2(this.movementVector.x,this.movementVector.z);this.mesh.rotation.y=B.lerp(this.mesh.rotation.y,e,this.rotationSpeed*.016);const i=this.movementVector.z*.6;this.mesh.rotation.x=B.lerp(this.mesh.rotation.x,i,this.rotationSpeed*.016);const s=Math.abs(this.movementVector.z),o=this.movementVector.x*s*.2;this.mesh.rotation.z=B.lerp(this.mesh.rotation.z,o,this.rotationSpeed*.016)}else this.mesh.rotation.x=B.lerp(this.mesh.rotation.x,0,this.rotationSpeed*.016),this.mesh.rotation.z=B.lerp(this.mesh.rotation.z,0,this.rotationSpeed*.016)}update(){this.mesh.position.copy(this.physicsBody.position);const t=Date.now()*.001,e=Math.sin(t*2)*.02;if(this.mesh.position.y+=e,this.bodyParts&&this.isMoving){const i=t*4;this.bodyParts.leftArm.rotation.x=Math.sin(i)*.5,this.bodyParts.rightArm.rotation.x=Math.sin(i+Math.PI)*.5,this.bodyParts.leftLeg.rotation.x=Math.sin(i*1.5)*.3,this.bodyParts.rightLeg.rotation.x=Math.sin(i*1.5+Math.PI)*.3}else if(this.bodyParts){const i=t*.5;this.bodyParts.leftArm.rotation.x=Math.sin(i)*.1,this.bodyParts.rightArm.rotation.x=Math.sin(i+Math.PI)*.1,this.bodyParts.leftLeg.rotation.x=Math.sin(i*.8)*.05,this.bodyParts.rightLeg.rotation.x=Math.sin(i*.8+Math.PI)*.05}}handleCollisions(t){for(const e of t)e.type==="collectible"?this.handleCollectibleCollision(e):e.type==="obstacle"?this.handleObstacleCollision(e):e.type==="environment"&&this.handleEnvironmentCollision(e)}handleCollectibleCollision(t){console.log("Player collected item:",t)}handleObstacleCollision(t){const e=this.physicsBody.position.clone().sub(t.position).normalize();this.physicsBody.velocity.add(e.multiplyScalar(2))}handleEnvironmentCollision(){}getPosition(){return this.physicsBody.position.clone()}setPosition(t){this.mesh.position.copy(t),this.physicsBody.position.copy(t)}getVelocity(){return this.physicsBody.velocity.clone()}getIsMoving(){return this.isMoving||this.physicsBody.velocity.length()>.1}dispose(){this.physicsEngine.removeRigidBody(this.physicsBody),this.scene.remove(this.mesh),this.mesh.children?this.mesh.children.forEach(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose())}):(this.mesh.geometry&&this.mesh.geometry.dispose(),this.mesh.material&&this.mesh.material.dispose())}}class gt{constructor(t,e,i=new h(0,0,-15)){this.scene=t,this.physicsEngine=e,this.position=i.clone(),this.width=4,this.height=6,this.depth=.5,this.isActivated=!1,this.isCollected=!1,this.pulseSpeed=.02,this.rotationSpeed=.01,this.time=0,this.createGateMesh(),this.createPhysicsBody(),console.log("🚪 Gate created at position:",i)}createGateMesh(){const t=new N(this.width,.3,8,32),e=new M({color:65535,emissive:26214,emissiveIntensity:.5,transparent:!0,opacity:.9,shininess:100});this.gateMesh=new y(t,e),this.gateMesh.position.copy(this.position),this.gateMesh.castShadow=!0,this.gateMesh.receiveShadow=!0;const i=new T(this.width*1.5,this.height),s=new V({color:35071,transparent:!0,opacity:.3,side:R});this.portalMesh=new y(i,s),this.portalMesh.position.copy(this.position),this.gateLight=new Y(65535,1,25),this.gateLight.position.copy(this.position),this.gateLight.position.z+=1,this.rimLights=[];const o=6;for(let n=0;n<o;n++){const r=n/o*Math.PI*2,a=new Y(35071,.3,10),c=this.width*1.2;a.position.set(this.position.x+Math.cos(r)*c,this.position.y+Math.sin(r)*c*.7,this.position.z+(Math.random()-.5)*2),a.userData={originalAngle:r,animationOffset:Math.random()*Math.PI*2},this.rimLights.push(a)}this.setVisibility(!1)}createPhysicsBody(){this.physicsBody=[];const t=this.width-.8,e=8;for(let s=0;s<e;s++){const o=s/e*Math.PI*2,n=Math.cos(o)*t,r=Math.sin(o)*t*.7,a=this.position.clone();a.x+=n,a.y+=r;const c=this.physicsEngine.createSphereBody(a,2,!0);c.type="gate",c.gate=this,this.physicsEngine.addRigidBody(c),this.physicsBody.push(c)}const i=this.physicsEngine.createSphereBody(this.position.clone(),3,!0);i.type="gate",i.gate=this,this.physicsEngine.addRigidBody(i),this.physicsBody.push(i)}activate(){this.isActivated||(this.isActivated=!0,this.setVisibility(!0),this.gateMesh.material.emissiveIntensity=.8,this.gateLight.intensity=1.5,this.rimLights.forEach(t=>{t.intensity=.4}),console.log("✨ Gate activated!"))}deactivate(){this.isActivated=!1,this.setVisibility(!1),this.gateMesh.material.emissiveIntensity=.5,this.gateLight.intensity=1,this.rimLights.forEach(t=>{t.intensity=.1})}setVisibility(t){t?(this.scene.add(this.gateMesh),this.scene.add(this.portalMesh),this.scene.add(this.gateLight),this.rimLights.forEach(e=>this.scene.add(e))):(this.scene.remove(this.gateMesh),this.scene.remove(this.portalMesh),this.scene.remove(this.gateLight),this.rimLights.forEach(e=>this.scene.remove(e)))}onPlayerEnter(){return!this.isActivated||this.isCollected?!1:(this.isCollected=!0,console.log("🎯 Player entered gate - Level Complete!"),this.gateMesh.material.emissiveIntensity=1,this.gateLight.intensity=2,!0)}update(t){if(!this.isActivated)return;this.time+=t;const e=.4+Math.sin(this.time*this.pulseSpeed*10)*.3;this.gateMesh.material.emissiveIntensity=e,this.gateLight.intensity=.8+e,this.gateMesh.rotation.z+=this.rotationSpeed,this.portalMesh.material.opacity=.2+Math.sin(this.time*this.pulseSpeed*15)*.2,this.rimLights.forEach((i,s)=>{const o=i.userData,n=this.time*.5+o.animationOffset,r=.2+Math.sin(n+s*.5)*.2;i.intensity=r;const a=this.width*1.2,c=Math.sin(n*2)*.1;i.position.set(this.position.x+Math.cos(o.originalAngle)*(a+c),this.position.y+Math.sin(o.originalAngle)*(a+c)*.7,this.position.z+Math.sin(n*3)*.5)})}getPosition(){return this.position.clone()}getIsActivated(){return this.isActivated}getIsCollected(){return this.isCollected}reset(){this.isCollected=!1,this.deactivate(),this.time=0}dispose(){Array.isArray(this.physicsBody)?this.physicsBody.forEach(t=>{this.physicsEngine.removeRigidBody(t)}):this.physicsBody&&this.physicsEngine.removeRigidBody(this.physicsBody),this.setVisibility(!1),this.gateMesh&&(this.gateMesh.geometry.dispose(),this.gateMesh.material.dispose()),this.portalMesh&&(this.portalMesh.geometry.dispose(),this.portalMesh.material.dispose()),console.log("🗑️ Gate disposed")}}class O{static create(t=.2,e=.4,i=5,s=.1){const o=new j,r=Math.PI*2/i/2;let a=-Math.PI/2;o.moveTo(Math.cos(a)*e,Math.sin(a)*e);for(let d=0;d<i;d++)a+=r,o.lineTo(Math.cos(a)*t,Math.sin(a)*t),a+=r,o.lineTo(Math.cos(a)*e,Math.sin(a)*e);const c={depth:s,bevelEnabled:!0,bevelSegments:2,steps:2,bevelSize:.02,bevelThickness:.02},l=new _(o,c);return l.center(),l}static createMaterial(t=16766720,e=.6){return new M({color:t,emissive:t,emissiveIntensity:e,shininess:100,specular:16777215,transparent:!0,opacity:.95})}static createVariants(){const t=[];return[{inner:.15,outer:.35,color:16766720},{inner:.18,outer:.38,color:16777088},{inner:.12,outer:.32,color:16753920},{inner:.2,outer:.4,color:16775885},{inner:.16,outer:.36,color:16757575}].forEach(i=>{const s=O.create(i.inner,i.outer),o=O.createMaterial(i.color);t.push({geometry:s,material:o,config:i})}),t}}const F={canvasId:"gameCanvas",loadingId:"loading",uiId:"ui"};class wt{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.canvas=null,this.isLoaded=!1,this.isMobile=this.detectMobile(),this.physicsEngine=null,this.particleSystem=null,this.audioEngine=null,this.player=null,this.gate=null,this.environmentObjects=[],this.seaCreatures=[],this.starCount=0,this.levelNumber=1,this.inputState={keys:{forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1},joystick:{x:0,y:0},cameraJoystick:{x:0,y:0},mobileButtons:{swimUp:!1,swimDown:!1}},this.cameraRotation={horizontal:0,vertical:0,sensitivity:this.isMobile?.003:.005},this.previousMovementDirection=null,this.lastTime=0,console.log("🌊 Ocean Adventure - Initializing...")}async initialize(){const t=[{name:"Canvas Setup",fn:()=>this.setupCanvas()},{name:"WebGL Renderer",fn:()=>this.setupRenderer()},{name:"3D Scene",fn:()=>this.setupScene()},{name:"Camera",fn:()=>this.setupCamera()},{name:"Lighting",fn:()=>this.setupLights()},{name:"Physics Engine",fn:()=>this.initializePhysics()},{name:"Particle System",fn:()=>this.initializeParticleSystem()},{name:"Audio Engine",fn:()=>this.initializeAudio()},{name:"Environment",fn:()=>this.createUnderwaterEnvironment()},{name:"Player",fn:()=>this.createPlayer()},{name:"Sample Stars",fn:()=>this.createSampleStars()},{name:"Gate",fn:()=>this.createGate()},{name:"Sea Creatures",fn:()=>this.createSeaCreatures()},{name:"Event Listeners",fn:()=>this.setupEventListeners()},{name:"UI Initialization",fn:()=>{this.hideLoading(),this.showUI()}},{name:"Game Loop",fn:()=>this.startGameLoop()}];try{console.log("🎮 Ocean Adventure - Starting initialization...");for(let e=0;e<t.length;e++){const i=t[e];console.log("[".concat(e+1,"/").concat(t.length,"] Initializing ").concat(i.name,"..."));try{await i.fn(),console.log("✅ ".concat(i.name," initialized successfully"))}catch(s){throw console.error("❌ Failed to initialize ".concat(i.name,":"),s),new Error('Initialization failed at step "'.concat(i.name,'": ').concat(s.message))}}this.isLoaded=!0,console.log("🎉 Ocean Adventure - Ready to play!")}catch(e){console.error("❌ Failed to initialize game:",e),this.showError("Failed to initialize game: "+e.message)}}setupCanvas(){if(console.log("🎮 Setting up canvas..."),this.canvas=document.getElementById(F.canvasId),!this.canvas)throw new Error("Game canvas not found");console.log("✅ Canvas found and configured")}setupRenderer(){console.log("🎨 Setting up WebGL renderer...");try{this.renderer=new Z({canvas:this.canvas,antialias:!this.isMobile,alpha:!1,powerPreference:this.isMobile?"low-power":"high-performance",failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,stencil:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setClearColor(6192,1),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=this.isMobile?Q:tt,this.renderer.outputColorSpace=et,this.renderer.toneMapping=it,this.renderer.toneMappingExposure=1;const t=this.renderer.getContext();if(!t)throw new Error("Failed to get WebGL context");t.getExtension("WEBGL_lose_context"),console.log("✅ WebGL renderer configured successfully")}catch(t){throw console.error("❌ Failed to setup WebGL renderer:",t),new Error("WebGL initialization failed: ".concat(t.message))}}setupScene(){console.log("🌊 Setting up 3D scene..."),this.scene=new st,console.log("✅ 3D scene created successfully")}initializePhysics(){this.physicsEngine=new ut,console.log("⚡ Physics engine initialized")}initializeParticleSystem(){this.particleSystem=new pt(this.scene,500),console.log("✨ Particle system initialized")}initializeAudio(){this.audioEngine=new yt,console.log("🔊 Audio engine created (will initialize on user interaction)")}async tryInitializeAudio(){if(this.audioEngine&&!this.audioEngine.isInitialized)try{await this.audioEngine.initialize(),this.audioEngine.startAmbientSound(),console.log("🌊 Audio initialized and ambient sound started")}catch(t){console.warn("Audio initialization failed:",t)}}setupCamera(){this.camera=new ot(75,window.innerWidth/window.innerHeight,.1,2e3),this.camera.position.set(0,5,15),this.camera.lookAt(0,-5,0)}setupLights(){const t=new nt(3368601,.3);this.scene.add(t);const e=new D(8900331,2.5);if(e.position.set(0,50,10),this.renderer.shadowMap.enabled){e.castShadow=!0;const s=this.isMobile?512:1024;e.shadow.mapSize.width=s,e.shadow.mapSize.height=s,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-50,e.shadow.camera.right=50,e.shadow.camera.top=50,e.shadow.camera.bottom=-50,this.isMobile&&(e.shadow.bias=-5e-4)}this.scene.add(e),this.addUnderwaterVolumetricLights();const i=new D(4890367,.8);i.position.set(-20,10,-20),this.scene.add(i),this.createSkybox()}createSkybox(){const t=new C(1500,32,32),e=new V({color:8900331,side:at,transparent:!1,fog:!1}),i=new y(t,e);i.position.set(0,0,0),this.scene.add(i),this.createClouds(),console.log("☁️ Skybox created")}createClouds(){this.clouds=[];for(let t=0;t<12;t++){const e=new L,i=3+Math.floor(Math.random()*3);for(let r=0;r<i;r++){const a=8+Math.random()*12,c=new C(a,16,16),l=new V({color:16777215,transparent:!0,opacity:.8+Math.random()*.2,fog:!1}),d=new y(c,l);d.position.set((Math.random()-.5)*25,(Math.random()-.5)*8,(Math.random()-.5)*25),e.add(d)}const s=t/12*Math.PI*2,o=300+Math.random()*200;e.position.set(Math.cos(s)*o,60+Math.random()*40,Math.sin(s)*o);const n=3+Math.random()*2;e.scale.setScalar(n),e.userData={originalPosition:e.position.clone(),speed:.01+Math.random()*.01,offset:Math.random()*Math.PI*2},this.clouds.push(e),this.scene.add(e)}console.log("☁️ Created ".concat(this.clouds.length," distant sky cloud clusters"))}addUnderwaterVolumetricLights(){const t=[4890367,8900331,6591981,49151],e=this.isMobile?3:5;for(let i=0;i<e;i++){const s=new Y(t[i%t.length],this.isMobile?2:3,30,2),o=i/e*Math.PI*2,n=15+Math.random()*10;s.position.set(Math.cos(o)*n,8+Math.random()*5,Math.sin(o)*n),s.userData={originalPosition:s.position.clone(),animationOffset:Math.random()*Math.PI*2,animationSpeed:.5+Math.random()*.5,animationRadius:2+Math.random()*3},this.scene.add(s),this.volumetricLights||(this.volumetricLights=[]),this.volumetricLights.push(s)}}createCelestialBody(){const t=this.levelNumber%2===0;if(t){const e=new C(8,32,32),i=new V({color:16768324,transparent:!1});this.celestialBody=new y(e,i),this.celestialBody.position.set(50,40,-40),this.celestialLight=new D(16777215,1.5),this.celestialLight.position.copy(this.celestialBody.position),this.celestialLight.target.position.set(0,5,0),console.log("☀️ Sun created for even level",this.levelNumber)}else{const e=new C(6,32,32),i=new V({color:13421789,transparent:!1});this.celestialBody=new y(e,i),this.celestialBody.position.set(-45,35,-35),this.celestialLight=new D(10066363,.8),this.celestialLight.position.copy(this.celestialBody.position),this.celestialLight.target.position.set(0,5,0),console.log("🌙 Moon created for odd level",this.levelNumber)}this.celestialBody.userData={originalPosition:this.celestialBody.position.clone(),isEvenLevel:t,animationRadius:15,animationSpeed:.2},this.scene.add(this.celestialBody),this.scene.add(this.celestialLight),this.scene.add(this.celestialLight.target)}initializeUnderwaterAtmosphere(){this.underwaterFog={enabled:!1,color:new x(26265),near:15,far:40},this.originalSceneBackground=this.scene.background,this.originalClearColor=this.renderer.getClearColor(new x),this.isUnderwater=!1,console.log("🌊 Underwater atmosphere system initialized")}updateUnderwaterAtmosphere(){const t=this.player?this.player.getPosition():{y:-10},e=5,i=this.isUnderwater;if(this.isUnderwater=t.y<e,this.isUnderwater!==i&&(this.isUnderwater?(this.scene.fog=new rt(this.underwaterFog.color,this.underwaterFog.near,this.underwaterFog.far),this.renderer.setClearColor(17510,1),this.scene.children&&this.scene.children.forEach(s=>{s.material&&s.material.color&&s.geometry&&s.geometry.type==="SphereGeometry"&&s.material.color.setHex(17510)}),console.log("🌊 Entered underwater - fog and blue tinting applied")):(this.scene.fog=null,this.renderer.setClearColor(8900331,1),this.scene.children&&this.scene.children.forEach(s=>{s.material&&s.material.color&&s.geometry&&s.geometry.type==="SphereGeometry"&&s.material.color.setHex(8900331)}),this.clouds&&this.clouds.forEach(s=>{s.visible=!0,s.children.forEach(o=>{o.material&&(o.material.opacity=Math.max(.8,o.material.opacity),o.material.visible=!0),o.visible=!0})}),console.log("🌊 Exited underwater - fog removed, sky elements restored"))),this.isUnderwater&&this.scene.fog){const s=Math.max(0,e-t.y),n=Math.min(1,s/15);this.scene.fog.far=this.underwaterFog.far*(1-n*.3);const r=new x(13141);this.scene.fog.color.lerpColors(this.underwaterFog.color,r,n*.25)}}createUnderwaterEnvironment(){const t=new T(300,300,96,96),e=new M({color:39423,transparent:!1,side:R,shininess:100,specular:16777215,fog:!1,wireframe:!1,emissive:26316}),i=new y(t,e);i.name="waveSurface",i.rotation.x=-Math.PI/2,i.position.y=5,this.scene.add(i),console.log("🌊 Wave surface created at position:",i.position),this.waveSurface=i,this.waveParams={amplitude:8,frequency:.15,speed:3};const s=i.geometry.attributes.position.array;this.waveOriginalPositions=new Float32Array(s.length);for(let u=0;u<s.length;u++)this.waveOriginalPositions[u]=s[u];const o=new T(400,400,64,64),n=new V({color:16777215,transparent:!0,opacity:.3,side:R,alphaTest:.1,depthWrite:!1}),r=new y(o,n);r.rotation.x=-Math.PI/2,r.position.y=5.2,this.scene.add(r),this.foamSurface=r,this.foamOriginalPositions=new Float32Array(o.attributes.position.array),this.initializeUnderwaterAtmosphere(),this.createCelestialBody();const a=new T(100,100,32,32),c=new M({color:9139029,shininess:10,specular:4473924,transparent:!1}),l=new y(a,c);l.rotation.x=-Math.PI/2,l.position.y=-15,l.receiveShadow=!0;const d=l.geometry.attributes.position.array;for(let u=2;u<d.length;u+=3)d[u]+=(Math.random()-.5)*.3;l.geometry.attributes.position.needsUpdate=!0,l.geometry.computeVertexNormals(),this.scene.add(l);for(let u=0;u<8;u++){const w=new ct(2+Math.random()*3,16),f=new M({color:new x().setHSL(.1,.3,.3+Math.random()*.2),shininess:5,transparent:!0,opacity:.7}),g=new y(w,f);g.rotation.x=-Math.PI/2,g.position.set((Math.random()-.5)*80,-14.9,(Math.random()-.5)*80),g.receiveShadow=!0,this.scene.add(g)}const p=this.physicsEngine.createBoxBody(new h(0,-15,0),new h(100,.1,100),!0);p.type="environment",this.physicsEngine.addRigidBody(p),this.createLevelBoundaries();const m=["coral","seaweed","rock","anemone","kelp"];for(let u=0;u<15;u++){const w=m[Math.floor(Math.random()*m.length)];let f,g,v;switch(w){case"coral":{f=new k(.1,.4,1+Math.random()*2,6),g=new M({color:new x().setHSL(.05+Math.random()*.15,.8,.4),shininess:40,transparent:!0,opacity:.9}),v=new y(f,g);for(let P=0;P<3;P++){const E=new C(.2+Math.random()*.3,8,6),b=new M({color:g.color.clone().multiplyScalar(.8+Math.random()*.4),shininess:60}),z=new y(E,b);z.position.set((Math.random()-.5)*.8,Math.random()*1.5,(Math.random()-.5)*.8),v.add(z)}break}case"seaweed":{f=new k(.05,.08,2+Math.random()*3,8),g=new M({color:new x().setHSL(.3,.7,.2+Math.random()*.3),shininess:20}),v=new y(f,g),v.scale.x=.3;break}case"kelp":{f=new X(.5,3+Math.random()*2,8),g=new M({color:new x().setHSL(.25,.6,.3),shininess:15}),v=new y(f,g);break}case"anemone":{f=new C(.4+Math.random()*.6,12,8),g=new M({color:new x().setHSL(.8+Math.random()*.2,.7,.6),shininess:80,transparent:!0,opacity:.85}),v=new y(f,g);for(let P=0;P<8;P++){const E=new k(.02,.05,.5,4),b=new y(E,g.clone()),z=P/8*Math.PI*2;b.position.set(Math.cos(z)*.4,.3,Math.sin(z)*.4),b.rotation.x=(Math.random()-.5)*.5,b.rotation.z=(Math.random()-.5)*.5,v.add(b)}break}default:{const P=.3+Math.random()*1.2;f=new lt(P,1),g=new M({color:new x().setHSL(.1,.2,.3+Math.random()*.3),shininess:10}),v=new y(f,g);const E=f.attributes.position.array;for(let b=0;b<E.length;b+=3)E[b]+=(Math.random()-.5)*.1,E[b+1]+=(Math.random()-.5)*.1,E[b+2]+=(Math.random()-.5)*.1;f.attributes.position.needsUpdate=!0,f.computeVertexNormals();break}}const A=new h((Math.random()-.5)*80,-14+Math.random()*2,(Math.random()-.5)*80);v.position.copy(A),v.castShadow=!0,v.receiveShadow=!0,(w==="seaweed"||w==="kelp")&&(v.userData.swaySpeed=.5+Math.random()*1.5,v.userData.swayAmount=.1+Math.random()*.2),this.scene.add(v);const q=w==="kelp"?1:w==="seaweed"?.3:.8,I=this.physicsEngine.createSphereBody(A,q,!0);I.type="environment",I.mesh=v,this.physicsEngine.addRigidBody(I),this.environmentObjects.push({mesh:v,physicsBody:I})}}createLevelBoundaries(){console.log("🧱 Creating level boundaries...");const t=50,e=15,i=2;[{position:new h(0,e/2-10,t),size:new h(t*2,e,i),name:"North Wall"},{position:new h(0,e/2-10,-t),size:new h(t*2,e,i),name:"South Wall"},{position:new h(t,e/2-10,0),size:new h(i,e,t*2),name:"East Wall"},{position:new h(-t,e/2-10,0),size:new h(i,e,t*2),name:"West Wall"}].forEach(o=>{const n=this.physicsEngine.createBoxBody(o.position,o.size,!0);n.type="environment",n.name=o.name,this.physicsEngine.addRigidBody(n),console.log("🧱 Created ".concat(o.name," at position (").concat(o.position.x.toFixed(1),", ").concat(o.position.y.toFixed(1),", ").concat(o.position.z.toFixed(1),")"))}),console.log("✅ Level boundaries created successfully")}createPlayer(){this.player=new ft(this.scene,this.physicsEngine),console.log("🏊 Player created with physics")}createGate(){const t=new h(0,-8,-15);this.gate=new gt(this.scene,this.physicsEngine,t),console.log("🚪 Gate created at position: (".concat(t.x,", ").concat(t.y,", ").concat(t.z,")"))}createSeaCreatures(){console.log("🐠 Creating sea creatures...");const t=["fish","jellyfish","seahorse"];for(let e=0;e<12;e++){const i=t[Math.floor(Math.random()*t.length)];let s,o,n;switch(i){case"fish":{const a=new L,c=new C(.3,8,6),l=new M({color:new x().setHSL(.1+Math.random()*.8,.8,.6),shininess:60}),d=new y(c,l);d.scale.set(1.5,1,.8),a.add(d);const p=new X(.15,.4,3),m=new M({color:l.color.clone().multiplyScalar(.8),shininess:40}),u=new y(p,m);u.position.set(-.4,0,0),u.rotation.z=Math.PI/2,a.add(u);const w=new X(.08,.2,3),f=new y(w,m.clone());f.position.set(.1,-.1,.2),f.rotation.x=Math.PI/4,a.add(f);const g=new y(w,m.clone());g.position.set(.1,-.1,-.2),g.rotation.x=-Math.PI/4,a.add(g),s=a,o=8+Math.random()*12,n=.3+Math.random()*.5;break}case"jellyfish":{const a=new L,c=new C(.4,8,6,0,Math.PI*2,0,Math.PI/2),l=new M({color:new x().setHSL(.7+Math.random()*.3,.5,.8),transparent:!0,opacity:.7,shininess:100}),d=new y(c,l);a.add(d);for(let p=0;p<6;p++){const m=new k(.02,.01,1.5,4),u=new y(m,l.clone()),w=p/6*Math.PI*2;u.position.set(Math.cos(w)*.3,-.7,Math.sin(w)*.3),u.userData.originalRotation={x:0,z:0},u.userData.tentacleIndex=p,a.add(u)}s=a,o=6+Math.random()*8,n=.1+Math.random()*.2;break}default:{const a=new L,c=new k(.1,.15,1,8),l=new M({color:new x().setHSL(.2+Math.random()*.4,.7,.5),shininess:40}),d=new y(c,l);d.rotation.z=Math.PI/6,a.add(d);const p=new C(.12,6,4),m=new y(p,l.clone());m.position.set(.1,.5,0),a.add(m);const u=new T(.15,.8),w=new M({color:l.color.clone().multiplyScalar(1.2),transparent:!0,opacity:.8,side:R}),f=new y(u,w);f.position.set(-.1,0,0),f.rotation.y=Math.PI/2,a.add(f),s=a,o=4+Math.random()*6,n=.2+Math.random()*.3;break}}const r=new h((Math.random()-.5)*60,-5-Math.random()*8,(Math.random()-.5)*60);s.position.copy(r),s.scale.setScalar(.8+Math.random()*.4),s.userData={creatureType:i,swimCenter:r.clone(),swimRadius:o,swimSpeed:n,swimAngle:Math.random()*Math.PI*2,bobOffset:Math.random()*Math.PI*2},this.scene.add(s),this.seaCreatures.push(s)}console.log("🐠 Created ".concat(this.seaCreatures.length," sea creatures"))}createSampleStars(){this.stars=[];const t=O.createVariants();for(let e=0;e<5;e++){const i=t[e%t.length],s=i.geometry.clone(),o=i.material.clone(),n=new y(s,o),r=new h((Math.random()-.5)*20,Math.random()*8-12,(Math.random()-.5)*20);n.position.copy(r),n.castShadow=!0;const a=this.physicsEngine.createSphereBody(r,1,!0);a.type="collectible",a.mesh=n,a.collected=!1,this.physicsEngine.addRigidBody(a),n.userData={rotationSpeed:.02+Math.random()*.02,floatSpeed:.01+Math.random()*.01,floatOffset:Math.random()*Math.PI*2,originalY:r.y,physicsBody:a,rotationAxis:new h(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize()},this.stars.push({mesh:n,physicsBody:a}),this.scene.add(n)}console.log("✨ Created ".concat(this.stars.length," sample stars"))}setupEventListeners(){window.addEventListener("resize",()=>this.onWindowResize(),{passive:!0}),window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t)),this.isMobile&&this.setupTouchControls(),this.setupSettingsModal()}onKeyDown(t){switch(this.tryInitializeAudio(),t.code){case"ArrowUp":case"KeyW":this.inputState.keys.forward=!0;break;case"ArrowDown":case"KeyS":this.inputState.keys.backward=!0;break;case"ArrowLeft":case"KeyA":this.inputState.keys.left=!0;break;case"ArrowRight":case"KeyD":this.inputState.keys.right=!0;break;case"Space":this.inputState.keys.up=!0,t.preventDefault();break;case"ShiftLeft":this.inputState.keys.down=!0;break}}onKeyUp(t){switch(t.code){case"ArrowUp":case"KeyW":this.inputState.keys.forward=!1;break;case"ArrowDown":case"KeyS":this.inputState.keys.backward=!1;break;case"ArrowLeft":case"KeyA":this.inputState.keys.left=!1;break;case"ArrowRight":case"KeyD":this.inputState.keys.right=!1;break;case"Space":this.inputState.keys.up=!1;break;case"ShiftLeft":this.inputState.keys.down=!1;break}}setupTouchControls(){this.setupVirtualJoystick(),this.setupCameraJoystick(),this.setupMobileButtons(),this.touchState={startX:0,startY:0,currentX:0,currentY:0,isActive:!1},this.canvas.addEventListener("touchstart",t=>{if(t.preventDefault(),this.tryInitializeAudio(),t.touches.length>0){const e=t.touches[0];this.touchState.startX=e.clientX,this.touchState.startY=e.clientY,this.touchState.currentX=e.clientX,this.touchState.currentY=e.clientY,this.touchState.isActive=!0}}),this.canvas.addEventListener("touchmove",t=>{if(t.preventDefault(),t.touches.length>0&&this.touchState.isActive){const e=t.touches[0];this.touchState.currentX=e.clientX,this.touchState.currentY=e.clientY;const i=this.touchState.currentX-this.touchState.startX,s=this.touchState.currentY-this.touchState.startY,o=.05,n=3;Math.abs(i)>20&&(this.player.position.x+=i/n*o*.01),Math.abs(s)>20&&(this.player.position.z+=s/n*o*.01),this.updateCamera()}}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.touchState.isActive=!1}),this.canvas.addEventListener("touchcancel",t=>{t.preventDefault(),this.touchState.isActive=!1})}setupVirtualJoystick(){const t=document.getElementById("virtualJoystick"),e=document.getElementById("joystickKnob");if(!t||!e)return;const i={isActive:!1,centerX:0,centerY:0,currentX:0,currentY:0};t.addEventListener("touchstart",s=>{if(s.preventDefault(),s.stopPropagation(),s.touches.length>0){const o=s.touches[0],n=t.getBoundingClientRect();i.isActive=!0,i.centerX=n.left+n.width/2,i.centerY=n.top+n.height/2,i.currentX=o.clientX,i.currentY=o.clientY,t.style.borderColor="rgba(255, 255, 255, 0.6)",t.style.background="rgba(0, 17, 34, 0.7)",this.updateJoystickKnob(e,i,n)}}),t.addEventListener("touchmove",s=>{if(s.preventDefault(),s.stopPropagation(),s.touches.length>0&&i.isActive){const o=s.touches[0],n=t.getBoundingClientRect();i.currentX=o.clientX,i.currentY=o.clientY;const r=i.currentX-i.centerX,a=i.currentY-i.centerY,c=Math.sqrt(r*r+a*a),l=n.width/2-20;if(c>5){const d=r/l,p=a/l;this.inputState.joystick.x=Math.max(-1,Math.min(1,d*1.2)),this.inputState.joystick.y=Math.max(-1,Math.min(1,p*1.2))}else this.inputState.joystick.x=0,this.inputState.joystick.y=0;this.updateJoystickKnob(e,i,n)}}),t.addEventListener("touchend",s=>{s.preventDefault(),s.stopPropagation(),i.isActive=!1,this.inputState.joystick.x=0,this.inputState.joystick.y=0,t.style.borderColor="rgba(255, 255, 255, 0.3)",t.style.background="rgba(0, 17, 34, 0.5)",e.style.transform="translate(-50%, -50%)"}),t.addEventListener("touchcancel",s=>{s.preventDefault(),s.stopPropagation(),i.isActive=!1,this.inputState.joystick.x=0,this.inputState.joystick.y=0,t.style.borderColor="rgba(255, 255, 255, 0.3)",t.style.background="rgba(0, 17, 34, 0.5)",e.style.transform="translate(-50%, -50%)"})}setupCameraJoystick(){const t=document.getElementById("cameraJoystick"),e=document.getElementById("cameraKnob");if(!t||!e)return;const i={isActive:!1,centerX:0,centerY:0,currentX:0,currentY:0};t.addEventListener("touchstart",s=>{if(s.preventDefault(),s.stopPropagation(),s.touches.length>0){const o=s.touches[0],n=t.getBoundingClientRect();i.isActive=!0,i.centerX=n.left+n.width/2,i.centerY=n.top+n.height/2,i.currentX=o.clientX,i.currentY=o.clientY,t.style.borderColor="rgba(255, 200, 100, 0.6)",t.style.background="rgba(0, 17, 34, 0.7)",this.updateCameraJoystickKnob(e,i,n)}}),t.addEventListener("touchmove",s=>{if(s.preventDefault(),s.stopPropagation(),s.touches.length>0&&i.isActive){const o=s.touches[0],n=t.getBoundingClientRect();i.currentX=o.clientX,i.currentY=o.clientY;const r=i.currentX-i.centerX,a=i.currentY-i.centerY,c=Math.sqrt(r*r+a*a),l=n.width/2-20;if(c>5){const d=r/l,p=a/l;this.inputState.cameraJoystick.x=Math.max(-1,Math.min(1,d*1.5)),this.inputState.cameraJoystick.y=Math.max(-1,Math.min(1,p*1.5))}else this.inputState.cameraJoystick.x=0,this.inputState.cameraJoystick.y=0;this.updateCameraJoystickKnob(e,i,n)}}),t.addEventListener("touchend",s=>{s.preventDefault(),s.stopPropagation(),i.isActive=!1,this.inputState.cameraJoystick.x=0,this.inputState.cameraJoystick.y=0,t.style.borderColor="rgba(255, 255, 255, 0.3)",t.style.background="rgba(0, 17, 34, 0.5)",e.style.transform="translate(-50%, -50%)"}),t.addEventListener("touchcancel",s=>{s.preventDefault(),s.stopPropagation(),i.isActive=!1,this.inputState.cameraJoystick.x=0,this.inputState.cameraJoystick.y=0,t.style.borderColor="rgba(255, 255, 255, 0.3)",t.style.background="rgba(0, 17, 34, 0.5)",e.style.transform="translate(-50%, -50%)"})}updateJoystickKnob(t,e,i){const s=e.currentX-e.centerX,o=e.currentY-e.centerY,n=Math.sqrt(s*s+o*o),r=i.width/2-20;if(n<=r)t.style.transform="translate(calc(-50% + ".concat(s,"px), calc(-50% + ").concat(o,"px))");else{const a=Math.atan2(o,s),c=Math.cos(a)*r,l=Math.sin(a)*r;t.style.transform="translate(calc(-50% + ".concat(c,"px), calc(-50% + ").concat(l,"px))")}}updateCameraJoystickKnob(t,e,i){const s=e.currentX-e.centerX,o=e.currentY-e.centerY,n=Math.sqrt(s*s+o*o),r=i.width/2-20;if(n<=r)t.style.transform="translate(calc(-50% + ".concat(s,"px), calc(-50% + ").concat(o,"px))");else{const a=Math.atan2(o,s),c=Math.cos(a)*r,l=Math.sin(a)*r;t.style.transform="translate(calc(-50% + ".concat(c,"px), calc(-50% + ").concat(l,"px))")}}setupMobileButtons(){const t=document.getElementById("swimUpBtn"),e=document.getElementById("swimDownBtn");t&&(t.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimUp=!0,t.style.background="rgba(255, 255, 255, 0.4)"}),t.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimUp=!1,t.style.background="rgba(0, 17, 34, 0.6)"}),t.addEventListener("touchcancel",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimUp=!1,t.style.background="rgba(0, 17, 34, 0.6)"})),e&&(e.addEventListener("touchstart",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimDown=!0,e.style.background="rgba(255, 255, 255, 0.4)"}),e.addEventListener("touchend",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimDown=!1,e.style.background="rgba(0, 17, 34, 0.6)"}),e.addEventListener("touchcancel",i=>{i.preventDefault(),i.stopPropagation(),this.inputState.mobileButtons.swimDown=!1,e.style.background="rgba(0, 17, 34, 0.6)"}))}setupSettingsModal(){const t=document.getElementById("settingsButton"),e=document.getElementById("settingsModal"),i=document.getElementById("closeSettings");if(t&&e&&i){const s=n=>{n&&(n.preventDefault(),n.stopPropagation()),e.classList.remove("hidden"),document.body.style.overflow="hidden",this.updateAudioSliders()},o=n=>{n&&(n.preventDefault(),n.stopPropagation()),e.classList.add("hidden"),document.body.style.overflow=""};t.addEventListener("click",s),i.addEventListener("click",o),e.addEventListener("click",n=>{n.target===e&&o(n)}),document.addEventListener("keydown",n=>{n.key==="Escape"&&!e.classList.contains("hidden")&&o()})}this.setupAudioControls()}setupAudioControls(){const t=document.getElementById("masterVolumeSlider"),e=document.getElementById("musicVolumeSlider"),i=document.getElementById("sfxVolumeSlider"),s=document.getElementById("masterVolumeValue"),o=document.getElementById("musicVolumeValue"),n=document.getElementById("sfxVolumeValue");t&&this.audioEngine&&t.addEventListener("input",r=>{const a=parseInt(r.target.value)/100;this.audioEngine.setMasterVolume(a),s&&(s.textContent="".concat(r.target.value,"%"))}),e&&this.audioEngine&&e.addEventListener("input",r=>{const a=parseInt(r.target.value)/100;this.audioEngine.setMusicVolume(a),o&&(o.textContent="".concat(r.target.value,"%"))}),i&&this.audioEngine&&i.addEventListener("input",r=>{const a=parseInt(r.target.value)/100;this.audioEngine.setSfxVolume(a),n&&(n.textContent="".concat(r.target.value,"%"))})}updateAudioSliders(){if(!this.audioEngine)return;const t=this.audioEngine.getState(),e=document.getElementById("masterVolumeSlider"),i=document.getElementById("musicVolumeSlider"),s=document.getElementById("sfxVolumeSlider"),o=document.getElementById("masterVolumeValue"),n=document.getElementById("musicVolumeValue"),r=document.getElementById("sfxVolumeValue");if(e){const a=Math.round(t.masterVolume*100);e.value=a,o&&(o.textContent="".concat(a,"%"))}if(i){const a=Math.round(t.musicVolume*100);i.value=a,n&&(n.textContent="".concat(a,"%"))}if(s){const a=Math.round(t.sfxVolume*100);s.value=a,r&&(r.textContent="".concat(a,"%"))}}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}updateCamera(t=.016){const e=this.player.getPosition();(this.inputState.cameraJoystick.x!==0||this.inputState.cameraJoystick.y!==0)&&(this.cameraRotation.horizontal+=this.inputState.cameraJoystick.x*this.cameraRotation.sensitivity*(60*t),this.cameraRotation.vertical+=this.inputState.cameraJoystick.y*this.cameraRotation.sensitivity*(60*t),this.cameraRotation.vertical=Math.max(-Math.PI/6,Math.min(Math.PI/2,this.cameraRotation.vertical)));const i=15,s=12,o=5-e.y,n=Math.min(3,Math.max(0,o-10)*.3),r=s+n,a=Math.sin(this.cameraRotation.horizontal)*i,c=Math.cos(this.cameraRotation.horizontal)*i,l=r+Math.sin(this.cameraRotation.vertical)*i*.5,d=new h(a,l,c),p=e.clone().add(d),m=.1;let u;this.isMobile?u=Math.min(1,Math.max(.6,window.innerWidth/1920)):u=Math.min(1.5,Math.max(.8,window.innerWidth/1920));const w=t*60;let f=1;if(this.player&&this.player.isMoving){const A=this.player.movementVector.clone().normalize();this.previousMovementDirection&&(f=1+(1-A.dot(this.previousMovementDirection))*.8),this.previousMovementDirection=A.clone()}else this.previousMovementDirection=null;const g=Math.min(1,m*u*w*f);this.camera.position.lerp(p,g);const v=e.clone();if(this.player&&this.player.isMoving){const A=this.player.movementVector.clone().normalize();v.add(A.multiplyScalar(2)),v.y+=1}else v.y+=2;this.camera.lookAt(v)}startGameLoop(){const t=e=>{requestAnimationFrame(t);const i=this.lastTime>0?(e-this.lastTime)/1e3:.016;this.lastTime=e,this.update(i),this.render()};t(0)}calculateGerstnerWave(t,e,i,s){const o=Math.sqrt(s.direction.x**2+s.direction.z**2),n=s.direction.x/o,r=s.direction.z/o,a=(n*t+r*e)*s.frequency+i*s.speed,c=Math.sin(a),l=Math.cos(a),d=s.steepness/s.frequency;return{x:d*n*c*s.amplitude,y:l*s.amplitude,z:d*r*c*s.amplitude}}update(t){if(!this.isLoaded)return;t=Math.min(t,.033),this.physicsEngine.update(t);const e=this.player.getPosition().clone();if(this.player.handleInput(this.inputState),this.player.update(),this.audioEngine&&this.audioEngine.isInitialized){const s=this.player.getPosition();e.distanceTo(s)>.01&&Math.random()<.05&&this.audioEngine.playSound("swimming",s)}if(this.particleSystem.update(t),this.gate&&this.gate.update(t),this.audioEngine&&this.audioEngine.isInitialized){const s=this.player.getPosition(),o=this.camera.getWorldDirection(new h),n=this.camera.up;this.audioEngine.updateListenerPosition(s,o,n)}this.updateCamera(t),this.updateUnderwaterAtmosphere(),this.updateUI(),this.stars.forEach(s=>{const o=s.mesh,n=o.userData;n.rotationAxis?o.rotateOnAxis(n.rotationAxis,n.rotationSpeed):(o.rotation.y+=n.rotationSpeed,o.rotation.x+=n.rotationSpeed*.5);const r=Date.now()*.001,a=n.originalY+Math.sin(r*n.floatSpeed+n.floatOffset)*.3;o.position.y=a;const c=.5+Math.sin(r*2+n.floatOffset)*.3;o.material.emissiveIntensity=c}),this.environmentObjects.forEach(s=>{const o=s.mesh;if(o.userData.swaySpeed&&o.userData.swayAmount){const n=Date.now()*.001,r=Math.sin(n*o.userData.swaySpeed)*o.userData.swayAmount,a=Math.cos(n*o.userData.swaySpeed*.7)*o.userData.swayAmount*.5;o.rotation.x=r,o.rotation.z=a}}),this.seaCreatures.forEach(s=>{const o=s.userData,n=Date.now()*.001;o.swimAngle+=o.swimSpeed*t;const r=o.swimCenter.x+Math.cos(o.swimAngle)*o.swimRadius,a=o.swimCenter.z+Math.sin(o.swimAngle)*o.swimRadius,c=o.swimCenter.y+Math.sin(n+o.bobOffset)*.5;s.position.set(r,c,a);const l=o.swimAngle+Math.PI/2;if(s.rotation.y=l,o.creatureType==="jellyfish"){s.children.forEach(p=>{if(p.userData.tentacleIndex!==void 0){const m=Math.sin(n*3+p.userData.tentacleIndex)*.3;p.rotation.x=m,p.rotation.z=Math.sin(n*2+p.userData.tentacleIndex)*.2}});const d=1+Math.sin(n*2)*.1;s.children[0]&&s.children[0].scale.setScalar(d)}else o.creatureType==="fish"?(s.children[1]&&(s.children[1].rotation.y=Math.sin(n*8)*.3),s.children.forEach((d,p)=>{p>1&&(d.rotation.z=d.rotation.z+Math.sin(n*6+p)*.1)})):o.creatureType==="seahorse"&&s.children.forEach(d=>{d.geometry&&d.geometry.type==="PlaneGeometry"&&(d.rotation.z=Math.sin(n*5)*.2)})});const i=Date.now()*.001;if(this.waveSurface&&this.waveOriginalPositions){const s=Date.now()*.001,o=this.waveSurface.geometry.attributes.position.array;for(let n=0;n<o.length;n+=3){const r=this.waveOriginalPositions[n],a=this.waveOriginalPositions[n+2],c=Math.sin(r*this.waveParams.frequency+s*this.waveParams.speed)*this.waveParams.amplitude,l=Math.sin(a*this.waveParams.frequency*.7+s*this.waveParams.speed*.8)*this.waveParams.amplitude*.6,d=Math.sin((r+a)*this.waveParams.frequency*1.3+s*this.waveParams.speed*1.2)*this.waveParams.amplitude*.4,p=c+l+d;o[n]=r,o[n+1]=p,o[n+2]=a}this.waveSurface.geometry.attributes.position.needsUpdate=!0}if(this.foamSurface&&this.foamOriginalPositions){const s=this.foamSurface.geometry.attributes.position.array;for(let o=0;o<s.length;o+=3){const n=this.foamOriginalPositions[o],r=this.foamOriginalPositions[o+2],a=Math.sin(n*.1+i*2)*3+Math.sin(r*.15+i*1.5)*2,c=1.5;a>c?(s[o+1]=a+.2,this.foamSurface.material.opacity=Math.min(.6,(a-c)*.3)):s[o+1]=-10}this.foamSurface.geometry.attributes.position.needsUpdate=!0}if(this.clouds&&this.clouds.forEach(s=>{const o=s.userData,n=i*o.speed+o.offset;s.position.x=o.originalPosition.x+Math.sin(n)*3,s.position.z=o.originalPosition.z+Math.cos(n*.7)*2,s.children.forEach((r,a)=>{r.rotation.y+=.002+a*.001;const c=r.material.opacity||.8;r.material.opacity=Math.max(.6,c+Math.sin(n*2+a)*.1)})}),this.celestialBody&&this.celestialBody.userData){const s=this.celestialBody.userData,o=i*s.animationSpeed,n=s.isEvenLevel?0:Math.PI,r=o+n,a=Math.cos(r)*s.animationRadius+s.originalPosition.x,c=Math.abs(Math.sin(r))*15+25,l=s.originalPosition.z;this.celestialBody.position.set(a,c,l),this.celestialLight&&this.celestialLight.position.copy(this.celestialBody.position)}this.volumetricLights&&this.volumetricLights.forEach(s=>{const o=s.userData,n=i*o.animationSpeed+o.animationOffset,r=Math.sin(n)*o.animationRadius,a=Math.cos(n*1.3)*o.animationRadius,c=Math.sin(n*.7)*1;s.position.x=o.originalPosition.x+r,s.position.y=o.originalPosition.y+c,s.position.z=o.originalPosition.z+a;const l=.8+Math.sin(n*3)*.2;s.intensity=(this.isMobile?.6:.8)*l}),this.checkStarCollection(),this.checkGateCollision()}checkStarCollection(){const t=this.physicsEngine.collisionSystem.checkCollisions(this.player.physicsBody);for(const e of t)if(e.type==="collectible"&&!e.collected){e.collected=!0;const i=this.stars.find(s=>s.physicsBody===e);if(i){this.scene.remove(i.mesh),this.physicsEngine.removeRigidBody(i.physicsBody);const s=this.stars.indexOf(i);s!==-1&&this.stars.splice(s,1),this.starCount++,this.updateUI(),this.audioEngine&&this.audioEngine.playSound("starCollect",i.mesh.position),this.particleSystem.createBurst(i.mesh.position,{count:15,life:1.5,velocity:new h(0,2,0),velocityVariation:new h(3,3,3),color:new x(16766720),size:{min:3,max:8}}),console.log("⭐ Star collected! Total: ".concat(this.starCount)),this.stars.length===0&&this.activateGate()}}}activateGate(){this.gate&&!this.gate.getIsActivated()&&(this.gate.activate(),this.audioEngine&&this.audioEngine.playSound("gateActivate",this.gate.getPosition()),console.log("🚪 Gate activated! Swim through to complete level!"))}checkGateCollision(){if(!this.gate||!this.gate.getIsActivated())return;const t=this.physicsEngine.collisionSystem.checkCollisions(this.player.physicsBody);for(const e of t)if(e.type==="gate"&&e.gate&&(console.log("🎯 Gate collision detected!"),e.gate.onPlayerEnter())){console.log("🎉 Level completed via gate collision!"),this.levelComplete();break}}levelComplete(){console.log("🎉 Level Complete!"),this.startPortalTransition(),this.audioEngine&&this.audioEngine.playSound("levelComplete"),this.levelNumber++,this.gate&&this.gate.reset(),this.createSampleStars(),this.updateUI()}startPortalTransition(){if(console.log("🌊 Starting portal transition..."),this.particleSystem&&this.gate){const t=this.gate.getPosition();this.particleSystem.createBurst(t,{count:50,life:2.25,velocity:new h(0,1,0),velocityVariation:new h(6,4,6),size:{min:4,max:12},color:new x(8900331)}),this.particleSystem.createBurst(t,{count:30,life:3,velocity:new h(0,.5,0),velocityVariation:new h(4,3,4),size:{min:2,max:6},color:new x(16766720)})}this.camera&&this.startCameraShake(.3,1),this.createScreenFlash()}createScreenFlash(){const t=document.createElement("div");if(t.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: radial-gradient(circle, rgba(135, 206, 235, 0.3) 0%, transparent 70%);\n      pointer-events: none;\n      z-index: 1000;\n      animation: portalFlash 1.2s ease-out forwards;\n    ",!document.querySelector("#portalFlashStyle")){const e=document.createElement("style");e.id="portalFlashStyle",e.textContent="\n        @keyframes portalFlash {\n          0% { opacity: 0; }\n          20% { opacity: 1; }\n          100% { opacity: 0; }\n        }\n      ",document.head.appendChild(e)}document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},1200)}startCameraShake(t=.2,e=.5){if(!this.camera)return;const i=this.camera.position.clone(),s=Date.now(),o=()=>{const r=(Date.now()-s)/1e3/e;if(r<1){const a=t*(1-r),c=(Math.random()-.5)*a*2,l=(Math.random()-.5)*a*2,d=(Math.random()-.5)*a*2;this.camera.position.copy(i),this.camera.position.add(new h(c,l,d)),requestAnimationFrame(o)}else this.camera.position.copy(i)};o()}updateUI(){if(document.getElementById("starCount").textContent=this.starCount,document.getElementById("levelNumber").textContent=this.levelNumber,this.player){const i=5-this.player.getPosition().y,s=(i>=0,i.toFixed(1));document.getElementById("depthMeter").textContent=s}}render(){try{this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)}catch(t){this.webglErrorCount<5&&(console.warn("WebGL render error:",t),this.webglErrorCount=(this.webglErrorCount||0)+1)}}hideLoading(){const t=document.getElementById(F.loadingId);t&&t.classList.add("hidden")}showUI(){const t=document.getElementById(F.uiId);t&&t.classList.remove("hidden"),this.updateUI()}showError(t){const e=document.getElementById(F.loadingId);e&&(e.innerHTML='\n        <div style="color: #ff4444; text-align: center;">\n          <h3>⚠️ Error Loading Game</h3>\n          <p>'.concat(t,'</p>\n          <p style="margin-top: 20px; font-size: 14px; color: #ccc;">\n            Please check the browser console for more details and try refreshing the page.\n          </p>\n        </div>\n      '),e.classList.remove("hidden"))}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}window.addEventListener("DOMContentLoaded",async()=>{try{console.log("🌊 Ocean Adventure - Starting initialization...");const S=new wt;window.oceanAdventure=S,await S.initialize()}catch(S){console.error("❌ Critical error during game initialization:",S);const t=document.getElementById("loading");t&&(t.innerHTML='\n          <div style="color: #ff4444; text-align: center;">\n            <h3>⚠️ Critical Error</h3>\n            <p>Failed to initialize Ocean Adventure: '.concat(S.message,'</p>\n            <p style="margin-top: 20px; font-size: 14px; color: #ccc;">\n              Please check the browser console for more details and try refreshing the page.\n            </p>\n          </div>\n        '))}},{passive:!0});window.addEventListener("webglcontextlost",S=>{S.preventDefault(),console.warn("WebGL context lost")},{passive:!1});window.addEventListener("webglcontextrestored",()=>{console.log("WebGL context restored")},{passive:!0});document.addEventListener("visibilitychange",()=>{document.hidden?console.log("Game paused due to page visibility"):console.log("Game resumed")},{passive:!0});export{vt as __vite_legacy_guard};
//# sourceMappingURL=index-BJWO9A2-.js.map
